#!/usr/bin/lua

local rootdir = "/root"
local udisk_dir = rootdir.."/udisk/"

function GetCMDOutput( cmd )
	local fp = io.popen( cmd, "r" )
	local content = fp:read("*a")
	fp:close()
	
	if content == "" then content = nil end
	
	return content	
end

function FindUSBDisk( content )
	local u_disks = {
	        [1] = "ID_PATH=pci-0000:00:0e.5-usb-0:2:1.0-scsi-0:0:0:0",
	        [2] = "ID_PATH=pci-0000:00:0e.5-usb-0:3:1.0-scsi-0:0:0:0",
	        [3] = "ID_PATH=pci-0000:00:09.1-usb-0:2:1.0-scsi-0:0:0:0",
	        [4] = "ID_PATH=pci-0000:00:09.0-usb-0:2:1.0-scsi-0:0:0:0",
        }
        local l = 1
        local block_start, l, dev, part = content:find("block@(sd%a)@(sd%a%d)\n", l)
        if block_start > 0 then block_start = block_start - 3 end
        
        local block_end = content:find("\n\n", l)
        if block_end > 0 then block_end = block_end - 1 end
        
        local subblock = content:sub(block_start, block_end)
        
        if #subblock > 0 then 
                str = subblock:match("(ID_PATH=%S+)\n")
        	if str then
			for i, v in ipairs(u_disks) do
				if str:upper() == v:upper() then
				      return '/dev/'..dev, '/dev/'..part, i                         
				end
			end
			
			print("Can't find matched pci serials number.")
			return -1
		end
        else
		print("Can't find USB disk.")
                return -1
        end
end

function FindAndMountUDisk()
	local dev, part
	
	local content = GetCMDOutput( "udevinfo --export-db" )
	if content ~= nil and content ~= "" then
		dev, part = FindUSBDisk(content)
	end
	
	-- here, notice different filesystem type: ext2, or fat
	local ret = os.execute( "mount "..part.." "..udisk_dir )
	if not ret then return -1 end

	return 0
end

--
-- find U disk, mount it, and copy essential files into inner disk
--
os.execute("sleep 10")
os.execute("mkdir "..udisk_dir)
ret = FindAndMountUDisk()
if not ret then 
	print("Mount USB Disk error."); 
	return -1
end

-- copy yahei font file to /root/recovery
os.execute("cp "..udisk_dir.."/font.ttf  /root/recovery/")

return 0